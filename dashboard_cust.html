<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Pelanggan - Kopi Prima</title>

    <script>
      // Early redirect: if currentUser looks like an admin, jump to admin dashboard
      (function () {
        try {
          const s = localStorage.getItem("currentUser");
          if (!s) return;
          const u = JSON.parse(s);
          const looksAdmin =
            u &&
            ((u.role && String(u.role).toLowerCase().includes("admin")) ||
              u.is_admin === true ||
              u.isAdmin === true ||
              (Array.isArray(u.roles) &&
                u.roles.some((r) =>
                  String(r).toLowerCase().includes("admin")
                )) ||
              (u.email && String(u.email).toLowerCase().startsWith("admin")) ||
              (u.username &&
                String(u.username).toLowerCase().includes("admin")));
          if (looksAdmin) location.replace("dashboard_admin.html");
        } catch (e) {
          /* ignore and let page render for customers */
        }
      })();
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Inter, sans-serif;
        background: #f8fafc;
      }
      .card {
        border-radius: 12px;
      }
      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #8b4513;
        color: #fff;
        display: block;
        margin: 0 auto;
        line-height: 100px;
        text-align: center;
        font-size: 40px;
        font-weight: 600;
      }

      /* Brown themed buttons */
      .btn-brown {
        background: linear-gradient(135deg, #8b4513, #a0522d);
        color: #fff;
        border: none;
      }
      .btn-brown-outline {
        background: transparent;
        color: #8b4513;
        border: 1px solid #8b4513;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard Pelanggan</h2>
        <div>
          <a href="index.html" class="btn btn-brown-outline me-2">Beranda</a>
          <button id="logoutBtn" class="btn btn-brown">Logout</button>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-4">
          <div class="card p-4">
            <div class="text-center">
              <div class="profile-avatar" id="custAvatar">U</div>
              <h5 class="mt-3 text-center" id="custName">Nama Pelanggan</h5>
              <p class="text-muted mb-1 text-center" id="custEmail">-</p>
              <p class="text-muted text-center" id="custPhone">-</p>
            </div>
            <hr />
            <div>
              <h6>Statistik</h6>
              <div class="d-flex justify-content-between">
                <div>
                  <div class="h4 mb-0" id="custOrdersCount">0</div>
                  <small class="text-muted">Pesanan</small>
                </div>
                <div>
                  <div class="h4 mb-0" id="custTotalSpent">Rp 0</div>
                  <small class="text-muted">Total Belanja</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card p-4">
            <h5>Riwayat Pesanan</h5>
            <div id="ordersContainer" class="mt-3">
              <!-- orders injected here -->
            </div>
            <div class="mt-3 text-end">
              <a href="products.html" class="btn btn-primary">Belanja Lagi</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Customer dashboard: validate role with backend and load customer-scoped data
      (async function () {
        const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
        const userData = localStorage.getItem("currentUser");

        if (!isLoggedIn || !userData) {
          window.location.href = "login.html";
          return;
        }

        let user = null;
        try {
          user = JSON.parse(userData);
        } catch (e) {
          window.location.href = "login.html";
          return;
        }

        // Local quick admin detection to avoid flashing customer page
        function isAdminUser(u) {
          if (!u) return false;
          if (u.role && String(u.role).toLowerCase().includes("admin"))
            return true;
          if (u.is_admin === true || u.isAdmin === true) return true;
          if (
            Array.isArray(u.roles) &&
            u.roles.some((r) => String(r).toLowerCase().includes("admin"))
          )
            return true;
          if (u.email && String(u.email).toLowerCase().startsWith("admin"))
            return true;
          if (u.username && String(u.username).toLowerCase().includes("admin"))
            return true;
          return false;
        }

        if (isAdminUser(user)) {
          window.location.href = "dashboard_admin.html";
          return;
        }

        // Determine API base (use origin when served over http(s), fallback to localhost when opened via file://)
        const API_BASE =
          window.location &&
          window.location.protocol &&
          window.location.protocol.startsWith("http")
            ? `${window.location.origin}/api`
            : "http://localhost:5000/api";

        // Create a reusable loader for dashboard data so we can refresh later
        async function loadDashboard() {
          try {
            const res = await fetch(`${API_BASE}/customer/dashboard`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "X-User-ID": user.id,
              },
            });

            if (res.status === 401) {
              // Not authenticated
              window.location.href = "login.html";
              return;
            }

            if (res.status === 403) {
              // Access denied â€” maybe admin
              window.location.href = "dashboard_admin.html";
              return;
            }

            const payload = await res.json();
            if (!res.ok || payload.status === "error") {
              console.warn("Customer dashboard API error", payload);
            }

            // If API returned expected data, use it; otherwise fallback to localStorage
            const data = payload && payload.data ? payload.data : null;

            // Fill profile with clear fallbacks
            const displayName =
              (data &&
                data.customer &&
                (data.customer.username || data.customer.name)) ||
              user.username ||
              user.name ||
              "Nama Pelanggan";
            const displayEmail =
              (data && data.customer && data.customer.email) ||
              user.email ||
              "-";
            const displayPhone =
              (data && data.customer && data.customer.phone) ||
              user.phone ||
              "-";

            document.getElementById("custName").textContent = displayName;
            document.getElementById("custEmail").textContent = displayEmail;
            document.getElementById("custPhone").textContent = displayPhone;

            // Avatar initial should be the first letter of username (or name/email fallback)
            let avatarSource =
              (data &&
                data.customer &&
                (data.customer.username || data.customer.name)) ||
              user.username ||
              user.name ||
              user.email ||
              "U";
            const initial =
              String(avatarSource).trim().charAt(0).toUpperCase() || "U";
            const avatarEl = document.getElementById("custAvatar");
            if (avatarEl) avatarEl.textContent = initial;

            // Orders
            const ordersContainer = document.getElementById("ordersContainer");
            const recent =
              data && Array.isArray(data.recent_transactions)
                ? data.recent_transactions
                : [];

            if (!recent || recent.length === 0) {
              ordersContainer.innerHTML =
                '<p class="text-muted">Belum ada pesanan.</p>';
            } else {
              ordersContainer.innerHTML = recent
                .map(
                  (o) => `
              <div class="border rounded p-3 mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>${o.transaction_code || o.id}</strong><br/>
                    <small class="text-muted">${
                      o.created_at
                        ? new Date(o.created_at).toLocaleString()
                        : ""
                    }</small>
                  </div>
                  <div class="text-end">
                    <div>Rp ${(o.total_amount || o.total || 0).toLocaleString(
                      "id-ID"
                    )}</div>
                    <small class="badge ${
                      o.status === "completed"
                        ? "bg-success text-white"
                        : "bg-warning text-dark"
                    }">${o.status}</small>
                    <div class="mt-2">
                      <button class="btn btn-sm btn-outline-primary view-items-btn" data-txn-id="${
                        o.id
                      }">Lihat Item</button>
                    </div>
                  </div>
                </div>
                <div id="txn-items-${
                  o.id
                }" class="mt-2" style="display:none"></div>
              </div>
            `
                )
                .join("");
            }

            // Stats
            const ordersCount =
              data && typeof data.total_orders === "number"
                ? data.total_orders
                : recent.length;
            const totalSpent =
              data && typeof data.total_spent === "number"
                ? data.total_spent
                : recent.reduce(
                    (s, r) => s + (r.total_amount || r.total || 0),
                    0
                  );

            document.getElementById("custOrdersCount").textContent =
              ordersCount;
            document.getElementById("custTotalSpent").textContent =
              "Rp " + totalSpent.toLocaleString("id-ID");
          } catch (err) {
            console.error("Error loading customer dashboard:", err);
            // Fallback to localStorage-rendering if backend unreachable
            const orders = JSON.parse(
              localStorage.getItem("userOrders_" + (user.id || "guest")) || "[]"
            );
            const ordersContainer = document.getElementById("ordersContainer");
            if (orders.length === 0) {
              ordersContainer.innerHTML =
                '<p class="text-muted">Belum ada pesanan.</p>';
            } else {
              ordersContainer.innerHTML = orders
                .map(
                  (o) => `
              <div class="border rounded p-3 mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>${o.id}</strong><br/>
                    <small class="text-muted">${o.date}</small>
                  </div>
                  <div class="text-end">
                    <div>Rp ${(o.total || 0).toLocaleString("id-ID")}</div>
                    <small class="badge ${
                      o.status === "completed"
                        ? "bg-success text-white"
                        : "bg-warning text-dark"
                    }">${o.status}</small>
                  </div>
                </div>
              </div>
            `
                )
                .join("");
            }

            document.getElementById("custOrdersCount").textContent =
              orders.length;
            const total = orders.reduce((s, o) => s + (o.total || 0), 0);
            document.getElementById("custTotalSpent").textContent =
              "Rp " + total.toLocaleString("id-ID");
          }
        }

        // Initial load
        await loadDashboard();

        // Auto-refresh when another tab sets last_checkout or when page becomes visible again
        window.addEventListener("storage", (ev) => {
          if (!ev) return;
          if (ev.key === "last_checkout") {
            try {
              // small delay to let backend finalize
              setTimeout(() => {
                loadDashboard();
              }, 300);
            } catch (e) {
              /* ignore */
            }
          }
          // also refresh on cart_count changes
          if (ev.key === "cart_count") {
            try {
              loadDashboard();
            } catch (e) {}
          }
        });

        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            // if there is a recent checkout marker, refresh
            const last = localStorage.getItem("last_checkout");
            if (last) {
              try {
                // remove marker after reading
                localStorage.removeItem("last_checkout");
              } catch (e) {}
              setTimeout(() => loadDashboard(), 200);
            }
          }
        });

        // Delegate click for viewing transaction items with reliable toggle
        document.addEventListener("click", async (ev) => {
          const btn = ev.target.closest(".view-items-btn");
          if (!btn) return;
          const txnId = btn.getAttribute("data-txn-id");
          if (!txnId) return;
          const container = document.getElementById("txn-items-" + txnId);
          if (!container) return;

          // determine visibility using computed style
          const isVisible =
            window.getComputedStyle(container).display !== "none";
          if (isVisible) {
            container.style.display = "none";
            try {
              btn.textContent = "Lihat Item";
            } catch (e) {}
            return;
          }

          // if already loaded, just show
          if (container.innerHTML && container.innerHTML.trim() !== "") {
            container.style.display = "block";
            try {
              btn.textContent = "Sembunyikan Item";
            } catch (e) {}
            return;
          }

          // Fetch and display items
          try {
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = "Memuat...";

            const res = await fetch(`${API_BASE}/transactions/${txnId}`, {
              headers: { "X-User-ID": user.id },
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              container.innerHTML = `<div class="text-danger">Gagal memuat item: ${
                err.message || res.statusText
              }</div>`;
              container.style.display = "block";
              try {
                btn.textContent = "Lihat Item";
              } catch (e) {}
              btn.disabled = false;
              return;
            }

            const payload = await res.json();
            if (!payload || payload.status === "error") {
              container.innerHTML = `<div class="text-danger">${
                (payload && payload.message) || "Error"
              }</div>`;
              container.style.display = "block";
              try {
                btn.textContent = "Lihat Item";
              } catch (e) {}
              btn.disabled = false;
              return;
            }

            const txn = payload.data;
            if (!txn || !Array.isArray(txn.items) || txn.items.length === 0) {
              container.innerHTML =
                '<div class="text-muted">Tidak ada item di transaksi ini.</div>';
              container.style.display = "block";
              try {
                btn.textContent = "Sembunyikan Item";
              } catch (e) {}
              btn.disabled = false;
              return;
            }

            container.innerHTML = txn.items
              .map(
                (it) => `
                <div class="d-flex align-items-center gap-3 border rounded p-2 mb-2">
                  <div style="width:64px;height:48px">${
                    it.image_url
                      ? `<img src="${it.image_url}" style="width:64px;height:48px;object-fit:cover;border-radius:6px">`
                      : ""
                  }</div>
                  <div style="flex:1">
                    <div class="fw-bold">${
                      it.product_name || "ID " + it.product_id
                    }</div>
                    <div class="text-muted">Jumlah: ${
                      it.quantity
                    } &middot; Rp ${Number(it.price).toLocaleString(
                  "id-ID"
                )}</div>
                  </div>
                  <div class="text-end">Rp ${Number(it.subtotal).toLocaleString(
                    "id-ID"
                  )}</div>
                </div>
            `
              )
              .join("");

            container.style.display = "block";
            try {
              btn.textContent = "Sembunyikan Item";
            } catch (e) {}
            btn.disabled = false;
          } catch (e) {
            console.error("Error fetching txn items", e);
            container.innerHTML = `<div class="text-danger">Kesalahan memuat item.</div>`;
            container.style.display = "block";
            try {
              btn.textContent = "Lihat Item";
            } catch (err) {}
            btn.disabled = false;
          }
        });

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("isLoggedIn");
          localStorage.removeItem("currentUser");
          window.location.href = "index.html";
        });
      })();
    </script>
  </body>
</html>
